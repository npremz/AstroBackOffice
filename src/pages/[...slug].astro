---
import { db } from '../db';
import { entries } from '../db/schema';
import { eq } from 'drizzle-orm';
import BaseLayout from '../layouts/BaseLayout.astro';

// Get the slug from the URL
const { slug } = Astro.params;
const fullSlug = slug || '';

// Try to find the entry in the database
const [entry] = await db.select().from(entries).where(eq(entries.slug, fullSlug));

// If no entry found, return 404
if (!entry) {
  return Astro.redirect('/404');
}

// Import the layout component dynamically based on template
let LayoutComponent;
try {
  const layouts = import.meta.glob('../layouts/*.astro', { eager: true });
  const layoutPath = `../layouts/${entry.template}.astro`;
  LayoutComponent = layouts[layoutPath]?.default;
} catch (error) {
  console.error(`Layout ${entry.template} not found, using default`);
}

// Extract common fields for meta
const title = entry.data.title || entry.slug;
const description = entry.data.description || entry.data.content?.substring(0, 150) || '';
---

<BaseLayout title={title} description={description}>
  {LayoutComponent ? (
    <LayoutComponent entry={entry} />
  ) : (
    <!-- Default rendering if no specific layout -->
    <article class="max-w-4xl mx-auto px-4 py-16">
      <header class="mb-8">
        <h1 class="text-4xl font-bold text-gray-900 mb-4">{entry.data.title}</h1>
        {entry.data.author && (
          <p class="text-gray-600">By {entry.data.author}</p>
        )}
      </header>

      <div class="prose prose-lg max-w-none">
        {entry.data.description && (
          <p class="text-xl text-gray-700 mb-6">{entry.data.description}</p>
        )}

        {entry.data.content && (
          <div set:html={entry.data.content} />
        )}

        {entry.data.image && (
          <img src={entry.data.image} alt={entry.data.title} class="rounded-lg shadow-lg" />
        )}

        {entry.data.price !== undefined && (
          <div class="mt-8 p-6 bg-blue-50 rounded-lg">
            <p class="text-2xl font-bold text-blue-900">${entry.data.price}</p>
          </div>
        )}
      </div>
    </article>
  )}
</BaseLayout>
